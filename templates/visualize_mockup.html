{% extends "base.html" %}

{% block content %}
<h2>การแสดงผลแบบเรียลไทม์</h2>

<div style="position: relative; display: inline-block;">
  <!-- รูปเงามวย (PNG หรือ SVG) -->
  <img src="{{ url_for('static', filename='images/gai.jpg') }}" alt="Boxing Silhouette" style="width: 300px;">
  
  <!-- ตัวระบุ: ตำแหน่งของมันจะเปลี่ยนแปลงตามเหตุการณ์ -->
  <div id="marker" style="position: absolute; width: 20px; height: 20px; background: red; border-radius: 50%; display: none;"></div>
  
  <!-- ป้ายเพื่อแสดงค่าจากเซ็นเซอร์แรง -->
  <div id="forceLabel" style="position: absolute; color: red; font-weight: bold; display: none;"></div>
</div>

<p>เหตุการณ์ล่าสุด: <span id="latestEvent">N/A</span></p>

{% if training_active %}
  <p>ขณะนี้มีการฝึกรอบอยู่</p>
  <form method="POST" action="{{ url_for('stop') }}">
    <button type="submit" class="btn btn-danger">หยุดและบันทึกรอบ</button>
  </form>
{% else %}
  <p>ไม่มีการฝึกรอบที่กำลังดำเนินการ</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  // เปิดการเชื่อมต่อ SSE เพื่อรับการอัปเดตเซ็นเซอร์แบบเรียลไทม์
  const eventSource = new EventSource("/stream");
  
  eventSource.onmessage = function(event) {
    let data = JSON.parse(event.data);
    // ถ้าเป็น heartbeat ให้ข้ามไป
    if (data.heartbeat) return;
    
    let sensorEvent = data.event;
    let forceValues = data.max_force;
    let marker = document.getElementById("marker");
    let forceLabel = document.getElementById("forceLabel");
    let latestEventSpan = document.getElementById("latestEvent");
    
    if (!sensorEvent) {
      marker.style.display = "none";
      forceLabel.style.display = "none";
      latestEventSpan.textContent = "N/A";
      return;
    }
    
    // อัปเดตข้อความเหตุการณ์
    latestEventSpan.textContent = sensorEvent;
    
    // แสดงตัวระบุและป้าย
    marker.style.display = "block";
    forceLabel.style.display = "block";
    
    // จัดตำแหน่งตัวระบุและป้ายตามประเภทของเหตุการณ์
    if (sensorEvent === "Head") {
      // ปรับค่าต่างๆเหล่านี้ให้ตรงกับตำแหน่งหัวในรูปของคุณ
      marker.style.top = "5%";
      marker.style.left = "35%";
      forceLabel.style.top = "5%";
      forceLabel.style.left = "55%";
    } else {  // "Body"
      // ปรับค่าต่างๆเหล่านี้ให้ตรงกับตำแหน่งลำตัวในรูปของคุณ
      marker.style.top = "35%";
      marker.style.left = "48%";
      forceLabel.style.top = "35%";
      forceLabel.style.left = "55%";
    }
    
    // แสดงค่าจากเซ็นเซอร์แรง
    forceLabel.textContent = forceValues
  };

  eventSource.onerror = function(err) {
    console.error("ข้อผิดพลาด SSE:", err);
  };
</script>
{% endblock %}
